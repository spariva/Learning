DROP TABLE PE_LOCALIDAD CASCADE CONSTRAINT;
CREATE TABLE PE_LOCALIDAD(
    COD_LOCALIDAD NUMBER(15) PRIMARY KEY,
    NOMBRE VARCHAR2(15) NOT NULL
);
DROP TABLE PE_PROVEEDOR CASCADE CONSTRAINT;
CREATE TABLE PE_PROVEEDOR(
    COD_PROVEEDOR VARCHAR2(6) PRIMARY KEY,
    NOMBRE VARCHAR2(15) NOT NULL,
    TELEFONO VARCHAR2(30) NOT NULL,
    TIPO_PROVEEDOR VARCHAR2(15) NOT NULL
);
DROP TABLE PE_CLIENTE CASCADE CONSTRAINT;
CREATE TABLE PE_CLIENTE(
    COD_CLIENTE VARCHAR2(2),
    NOMBRE VARCHAR2(15) NOT NULL,
    DIRECC VARCHAR2(30) NOT NULL,
    COD_LOCALIDAD NUMBER NOT NULL,
    CONSTRAINT PK_CLIENTE PRIMARY KEY (COD_CLIENTE),
    CONSTRAINT FK_CLIENTE FOREIGN KEY (COD_LOCALIDAD) REFERENCES PE_LOCALIDAD(COD_LOCALIDAD) ON DELETE CASCADE
);
DROP TABLE PE_PRODUCTO CASCADE CONSTRAINT;
CREATE TABLE PE_PRODUCTO(
    COD_PRODUCTO VARCHAR2(15) PRIMARY KEY,
    DESCRIPCION VARCHAR2(20),
    PRECIO NUMBER(4,2) NOT NULL,
    COD_PROVEEDOR VARCHAR2(6),
    CONSTRAINT FK_PROD_PROV FOREIGN KEY (COD_PROVEEDOR) REFERENCES PE_PROVEEDOR(COD_PROVEEDOR) ON DELETE CASCADE
);
DROP TABLE PE_PEDIDO CASCADE CONSTRAINT;
CREATE TABLE PE_PEDIDO(
    COD_PEDIDO VARCHAR2(9) PRIMARY KEY,
    FECHA_PEDIDO DATE NOT NULL,
    COD_CLIENTE VARCHAR2(2) NOT NULL,
    COD_PRODUCTO VARCHAR2(15) NOT NULL,
    CANTIDAD_PEDIDA NUMBER(3) NOT NULL,
    CONSTRAINT FK_PED_CLIENTE FOREIGN KEY (COD_CLIENTE) REFERENCES PE_CLIENTE(COD_CLIENTE) ON DELETE CASCADE,
    CONSTRAINT FK_PED_PRODUCTO FOREIGN KEY (COD_PRODUCTO) REFERENCES PE_PRODUCTO(COD_PRODUCTO) ON DELETE CASCADE
);
INSERT INTO PE_LOCALIDAD VALUES('500','MADRID');
INSERT INTO PE_LOCALIDAD VALUES('600','LEGANES');

INSERT INTO PE_PROVEEDOR VALUES('PM11','FONTANEDA','91-8888888','P1');
INSERT INTO PE_PROVEEDOR VALUES('PM22','COLON','91-6666666','P1');
INSERT INTO PE_PROVEEDOR VALUES('PM33','COCA COLA','91-2222222','P2');

INSERT INTO PE_CLIENTE VALUES('32','JUAN SANCHEZ','RAMON SERRANO 8',500);
INSERT INTO PE_CLIENTE VALUES('25','ANTONIO LOPEZ','ALONDRA 300',600);
INSERT INTO PE_CLIENTE VALUES('45','CARLOS ORTEGA','GOYA 60',500);

INSERT INTO PE_PRODUCTO VALUES('111','GALLETAS',3,'PM11');
INSERT INTO PE_PRODUCTO VALUES('333','DETERGENTE',2.46,'PM22');
INSERT INTO PE_PRODUCTO VALUES('444','LATA COCA COLA',1.21,'PM33');
INSERT INTO PE_PRODUCTO VALUES('555','LATA FANTA',1.02,'PM33');
INSERT INTO PE_PRODUCTO VALUES('222','DELICIAS TE',11.98,'PM11');

INSERT INTO PE_PEDIDO VALUES('P-0001','12/03/2002','32','111',50);
INSERT INTO PE_PEDIDO VALUES('P-0002','12/04/2002','25','333',60);
INSERT INTO PE_PEDIDO VALUES('P-0003','13/05/2004','25','333',10);
INSERT INTO PE_PEDIDO VALUES('P-0004','14/05/2004','25','111',8);

ALTER TABLE PE_PRODUCTO ADD CONSTRAINT PROD_PRECIO CHECK (PRECIO>0);
ALTER TABLE PE_PROVEEDOR ADD CONSTRAINT VALOR_PROV CHECK (TIPO_PROVEEDOR IN ('P1','P2','P3'));
ALTER TABLE PE_LOCALIDAD ADD (NUM_HABITANTES NUMBER(6));
--NO LO HAGO NOT NULL PORQUE TENDRÍA ENTONCES QUE AÑADIR A CADA CIUDAD UN NÚMERO DE HABITANTES
INSERT INTO PE_LOCALIDAD VALUES(600,'VILNA',8000);
--No funciona porque tiene la misma pk que otra ciudad.
ALTER TABLE PE_LOCALIDAD ADD CONSTRAINT COD_LOC_SUPERIOR400 CHECK (COD_LOCALIDAD>400);

DROP TABLE PROVINCIA CASCADE CONSTRAINT;
CREATE TABLE PROVINCIA(
    COD_PROVINCIA VARCHAR2(15) PRIMARY KEY,
    NOMBRE_PROVINCIA VARCHAR2(15) NOT NULL
);
ALTER TABLE PE_LOCALIDAD ADD (COD_PROVINCIA VARCHAR2(15));
ALTER TABLE PE_LOCALIDAD ADD CONSTRAINT FK_PROV_LOCAL FOREIGN KEY (COD_PROVINCIA) REFERENCES PROVINCIA(COD_PROVINCIA) ON DELETE CASCADE;

UPDATE PE_PRODUCTO SET PRECIO=6.35 WHERE DESCRIPCION LIKE 'DETERGENTE';
UPDATE PE_PRODUCTO SET PRECIO=PRECIO*1.1 WHERE COD_PROVEEDOR IN
(SELECT COD_PROVEEDOR FROM PE_PROVEEDOR WHERE NOMBRE='FONTANEDA');
UPDATE PE_PEDIDO SET CANTIDAD_PEDIDA=10 WHERE COD_CLIENTE IN
(SELECT COD_CLIENTE FROM PE_CLIENTE WHERE NOMBRE='ANTONIO LOPEZ');

ALTER TABLE PE_PEDIDO ADD (IMPORTE_PEDIDO NUMBER);
UPDATE PE_PEDIDO SET IMPORTE_PEDIDO=CANTIDAD_PEDIDA*PRECIO;
DELETE FROM PE_CLIENTE WHERE COD_CLIENTE IN (SELECT C.COD_CLIENTE FROM PE_CLIENTE C,PE_PEDIDO PED  WHERE C.COD_CLIENTE=PED.COD_CLIENTE AND PED.COD_PEDIDO IS NULL);
DELETE FROM PE_PEDIDO WHERE CANTIDAD_PEDIDA>100;

ALTER TABLE PE_PEDIDO ADD (DESCUENTO NUMBER);
UPDATE PE_PEDIDO PE SET PE.DESCUENTO=(P.PRECIO*0.1) FROM PE_PRODUCTO P WHERE PE.COD_PRODUCTO = P.COD_PRODUCTO
AND YEAR(PE.FECHA_PEDIDO)=2002;

--1.   que muestre para cada cliente su nombre, los códigos de los pedidos realizados y el importe total de cada uno de ellos.
SELECT C.NOMBRE, P.COD_PEDIDO, P.IMPORTE FROM PE_CLIENTE C, PE_PEDIDO P WHERE C.COD_CLIENTE = P.COD_CLIENTE;
--2.	que muestre para cada cliente su nombre y el número de pedidos realizados.
SELECT C.NOMBRE, P.COD_PEDIDO, COUNT(*) FROM PE_CLIENTE C, PE_PEDIDO P GROUP BY C.NOMBRE, P.COD_PEDIDO;
--3.	que muestra para cada proveedor su nombre y la relación de productos que comercializa.
SELECT P.NOMBRE, PROD.COD_PRODUCTO FROM PE_PROVEEDOR P, PE_PRODUCTO PROD GROUP BY P.NOMBRE, PROD.COD_PRODUCTO;
--4.	que muestre los datos del artículo con el precio más alto.
SELECT * FROM PE_PRODUCTO WHERE PRECIO IN(SELECT MAX(PRECIO) FROM PE_PRODUCTO);
--5.	que muestre por cada localidad el número de clientes que residen en la misma.
SELECT COUNT(P.COD_CLIENTE),L.NOMBRE FROM PE_LOCALIDAD L, PE_CLIENTE P GROUP BY L.NOMBRE;
--6. que muestre la información de los pedidos en que haya productos del proveedor “Fontaneda”.
SELECT PE_PEDIDO.* FROM PE_PEDIDO,PE_PRODUCTO,PE_PROVEEDOR WHERE PE_PEDIDO.COD_PRODUCTO=PE_PRODUCTO.COD_PRODUCTO
AND PE_PRODUCTO.COD_PROVEEDOR=PE_PROVEEDOR.COD_PROVEEDOR 
AND PE_PROVEEDOR.NOMBRE='FONTANEDA';
--7. que muestre la información de los clientes que no hayan realizado ningún pedido.
SELECT * FROM PE_CLIENTE WHERE COD_CLIENTE NOT IN (SELECT COD_CLIENTE FROM PE_PEDIDO);
--8. Crear una vista VPE_GASTOCLIENTES que muestre para cada uno de los clientes el importe total gastado en los pedidos que ha realizado.
CREATE VIEW VPE_GASTOCLIENTES AS
SELECT C.NOMBRE "CLIENTE", SUM(PR.PRECIO*P.CANTIDAD_PEDIDA) "GASTO_TOTAL" FROM PE_CLIENTE C, PE_PEDIDO P, PE_PRODUCTO PR
WHERE P.COD_CLIENTE = C.COD_CLIENTE AND P.COD_PRODUCTO = PR.COD_PROD GROUP BY C.NOMBRE, PR.PRECIO;

--CREATE VIEW VPE_GASTOCLIENTES AS
--SELECT c.nombre, SUM(p.importe) AS total_gastado
--FROM tabla_de_pedidos p, pe_cliente c where c  p.codigo_de_cliente = c.codigo_de_cliente
--GROUP BY c.nombre;

--CREATE VIEW VPE_GASTOCLIENTES AS
--SELECT c.nombre AS cliente, SUM(p.importe) AS total_gastado
--FROM tabla_de_pedidos p
--JOIN tabla_de_clientes c ON p.codigo_de_cliente = c.codigo_de_cliente
--GROUP BY c.nombre, p.codigo_de_cliente;


